# Claude Code User Container
# This container runs per-user with their UID/GID and home directory
FROM node:20-bookworm-slim

# Install build dependencies for node-pty and Claude CLI
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    bash \
    bash-completion \
    curl \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Starship prompt
RUN sh -c "$(curl -fsSL https://starship.rs/install.sh)" -- --yes

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code

# Create app directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm install --production

# Copy application source
COPY server.js ./
COPY src/ ./src/
COPY public/ ./public/

# Create directories with open permissions (container runs as host user)
# Remove node user from /etc/passwd so host user's name displays correctly
RUN mkdir -p /app/data/environment /home/node/.config && \
    chmod -R 777 /app/data /home/node && \
    chmod 777 /etc/passwd /etc/group && \
    sed -i '/^node:/d' /etc/passwd

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Configure bash with starship and completions
RUN echo 'eval "$(starship init bash 2>/dev/null)"' >> /etc/bash.bashrc && \
    echo '[ -f /usr/share/bash-completion/bash_completion ] && source /usr/share/bash-completion/bash_completion' >> /etc/bash.bashrc && \
    echo 'export PS1="\\[\\033[01;32m\\]\\u@\\h\\[\\033[00m\\]:\\[\\033[01;34m\\]\\w\\[\\033[00m\\]\\$ "' >> /etc/bash.bashrc.fallback && \
    echo 'if command -v starship >/dev/null 2>&1; then eval "$(starship init bash 2>/dev/null)"; else source /etc/bash.bashrc.fallback; fi' > /etc/profile.d/starship.sh && \
    chmod +x /etc/profile.d/starship.sh

# The server.js in user container doesn't need authentication (gateway handles it)
ENV SINGLE_USER_MODE=true

# Expose port
EXPOSE 3000

# Use entrypoint to set up user mapping
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Start the server
CMD ["node", "server.js"]
